<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no">
  <title>商品介紹</title>
  <link rel="stylesheet" href="css/product-detail.css">
  <link href="https://fonts.googleapis.com/css2?family=Dela+Gothic+One&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Sawarabi+Mincho&display=swap" rel="stylesheet">
  <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
</head>
<body>
  <header>
    <div class="header-container">
      <h1 class="store-name"><a href="index.jsp">胖呆雜貨店</a></h1>
      <div class="nav-right">
        <a href="member.jsp">會員中心 ｜</a>
        <a href="shoppingcart.html" class="cart">🛒 購物車</a>
      </div>
    </div>
  </header>

  <main class="product-detail">
    <div class="product-content">
      <div class="product-info">
        <div class="product-image">
          <img id="detailImage" src="image/drink/1.JPG" alt="商品圖片">
        </div>
        <div class="product-header">
          <h1 id="detailName">香茅精油防護擴香液</h1>
          <p class="price">
            <span id="detailPrice">NT$200</span>
            <span class="original-price">NT$300</span>
          </p>
          <p>庫存：<span id="detailVolume">30</span></p>
        </div>
        <div style="margin: 15px 0;">
          <label for="quantity">數量：</label>
          <select id="quantity">
            <option value="1">1</option><option value="2">2</option>
            <option value="3">3</option><option value="4">4</option>
            <option value="5">5</option><option value="6">6</option>
            <option value="7">7</option><option value="8">8</option>
            <option value="9">9</option><option value="10">10</option>
          </select>
        </div>
        <div class="description">
          <p>商品資訊：<pre id="detailDescription">搭配優雅香氛</pre></p>
          <p class="stock-info">超過庫存訂購此商品需要 8 個工作天。</p>
        </div>
        <div style="display: flex; align-items: center; margin-top: 20px;">
          <button id="add-to-cart">加入購物車</button>
          <button id="product-wishlist-btn">
            <span id="product-heart-icon">♡</span>
          </button>
        </div>
      </div>

      <div class="product-review">
        <h2>商品評分與評論</h2>
        <h4>4.0 ★★★★☆ (100 條評論)</h4>
        <select id="sortReview">
          <option value="latest">時間：新→舊</option>
          <option value="oldest">時間：舊→新</option>
          <option value="highest">評分：高→低</option>
          <option value="lowest">評分：低→高</option>
        </select>
        <div class="product-reviews">
          <div class="reviews-list" id="reviews-list">
            <div class="review">
              <p class="reviewer-name">小明</p>
              <div class="review-rating">★★★★☆</div>
              <p class="review-text">包裝很完整，太喜歡了！</p>
              <span class="review-date">2024/12/30</span>
            </div>
          </div>
          <button id="toggle-review-form" style="margin-top: 10px;">我要寫評論</button>
          <div class="new-reviews" style="display: none;">
            <h2>新增評論</h2>
            <div class="star" id="star-rating1"></div>
            <textarea id="review" placeholder="請輸入評論"></textarea>
            <button id="submit-review">提交評論</button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer>
    <div class="footer-container">
      <div class="footer-item">
        <img src="image/photo13.jpg" height="100px" width="150px">
        <div class="text-container">
          <p>中原大學資管系</p>
          <p>☀ 全日公休（食物被代言人吃完 補貨中~_~）</p>
          <p>☏ 0959277777</p>
          <p>✉ pdhjzhd@gmail.com</p>
        </div>
      </div>
    </div>
    <div class="footer-bottom">
      <p>@2024 肥呆懷舊雜貨店</p>
    </div>
  </footer>

  <script>
  document.addEventListener("DOMContentLoaded", function () {
    const starContainer = document.getElementById("star-rating1");
    const reviewArea = document.querySelector('.new-reviews');
    const reviewList = document.getElementById("reviews-list");
    const productId = new URLSearchParams(window.location.search).get("id");

    document.getElementById("toggle-review-form").addEventListener("click", () => {
      reviewArea.style.display = 'block';
    });

    function sortReviews(criteria) {
      const reviewElements = Array.from(document.querySelectorAll("#reviews-list .review"));
      reviewElements.sort((a, b) => {
        const ratingA = a.querySelector(".review-rating").textContent.replace(/☆/g, "").length;
        const ratingB = b.querySelector(".review-rating").textContent.replace(/☆/g, "").length;
        const dateA = new Date(a.querySelector(".review-date").textContent);
        const dateB = new Date(b.querySelector(".review-date").textContent);
        switch (criteria) {
          case "highest": return ratingB - ratingA;
          case "lowest": return ratingA - ratingB;
          case "latest": return dateB - dateA;
          case "oldest": return dateA - dateB;
        }
      });
      reviewElements.forEach(el => reviewList.appendChild(el));
    }
    document.getElementById("sortReview").addEventListener("change", (e) => {
      sortReviews(e.target.value);
    });

    fetch("checkReviewPermission.jsp?productId=" + productId)
      .then(res => res.json())
      .then(data => {
        if (!data.isLogin) {
          reviewArea.innerHTML = '<p style="color:red;">請先登入會員後才能撰寫評論。</p>';
        } else if (!data.canReview) {
          reviewArea.innerHTML = '<p style="color:red;">您尚未購買此商品，無法撰寫評論。</p>';
        } else {
          reviewArea.style.display = 'none';
          for (let i = 1; i <= 5; i++) {
            const star = document.createElement("iconify-icon");
            star.setAttribute("icon", "material-symbols:star-outline");
            star.setAttribute("class", "star-icon");
            star.setAttribute("data-index", i);
            star.setAttribute("width", "40");
            starContainer.appendChild(star);
          }

          const stars = starContainer.querySelectorAll(".star-icon");
          stars.forEach((star, idx) => {
            star.addEventListener("click", () => {
              stars.forEach((s, i) => {
                s.setAttribute("icon", i <= idx ? "material-symbols:star" : "material-symbols:star-outline");
                s.classList.toggle("filled", i <= idx);
              });
            });
          });

          document.getElementById("submit-review").addEventListener("click", () => {
            const rating = document.querySelectorAll(".star-icon.filled").length;
            const comment = document.getElementById("review").value.trim();

            if (rating === 0 || comment === "") {
              alert("請輸入評論內容並選擇星星數！");
              return;
            }

            const formData = new FormData();
            formData.append("productId", productId);
            formData.append("rating", rating);
            formData.append("comment", comment);

            fetch("addReview.jsp", {
              method: "POST",
              body: formData
            })
            .then(res => res.text())
            .then(result => {
              if (result.includes("success")) {
                alert("評論成功送出！");
                const newDiv = document.createElement("div");
                newDiv.className = "review";
                const today = new Date().toISOString().split("T")[0];
                const starStr = "★".repeat(rating) + "☆".repeat(5 - rating);
                newDiv.innerHTML = `
                  <p class="reviewer-name">您</p>
                  <div class="review-rating">${starStr}</div>
                  <p class="review-text">${comment}</p>
                  <span class="review-date">${today}</span>`;
                reviewList.prepend(newDiv);
                document.getElementById("review").value = "";
                stars.forEach(s => {
                  s.setAttribute("icon", "material-symbols:star-outline");
                  s.classList.remove("filled");
                });
              } else {
                alert("送出失敗：" + result);
              }
            });
          });
        }
      });
  });
  </script>
</body>
</html>
