<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no">
  <title>å•†å“ä»‹ç´¹</title>
  <link rel="stylesheet" href="css/product-detail.css">
  <link href="https://fonts.googleapis.com/css2?family=Dela+Gothic+One&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Sawarabi+Mincho&display=swap" rel="stylesheet">
  <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
</head>
<body>
  <header>
    <div class="header-container">
      <h1 class="store-name"><a href="index.jsp">èƒ–å‘†é›œè²¨åº—</a></h1>
      <div class="nav-right">
        <a href="member.jsp">æœƒå“¡ä¸­å¿ƒ ï½œ</a>
        <a href="shoppingcart.html" class="cart">ğŸ›’ è³¼ç‰©è»Š</a>
      </div>
    </div>
  </header>

  <main class="product-detail">
    <div class="product-content">
      <div class="product-info">
        <div class="product-image">
          <img id="detailImage" src="image/drink/1.JPG" alt="å•†å“åœ–ç‰‡">
        </div>
        <div class="product-header">
          <h1 id="detailName">é¦™èŒ…ç²¾æ²¹é˜²è­·æ“´é¦™æ¶²</h1>
          <p class="price">
            <span id="detailPrice">NT$200</span>
            <span class="original-price">NT$300</span>
          </p>
          <p>åº«å­˜ï¼š<span id="detailVolume">30</span></p>
        </div>
        <div style="margin: 15px 0;">
          <label for="quantity">æ•¸é‡ï¼š</label>
          <select id="quantity">
            <option value="1">1</option><option value="2">2</option>
            <option value="3">3</option><option value="4">4</option>
            <option value="5">5</option><option value="6">6</option>
            <option value="7">7</option><option value="8">8</option>
            <option value="9">9</option><option value="10">10</option>
          </select>
        </div>
        <div class="description">
          <p>å•†å“è³‡è¨Šï¼š<pre id="detailDescription">æ­é…å„ªé›…é¦™æ°›</pre></p>
          <p class="stock-info">è¶…éåº«å­˜è¨‚è³¼æ­¤å•†å“éœ€è¦ 8 å€‹å·¥ä½œå¤©ã€‚</p>
        </div>
        <div style="display: flex; align-items: center; margin-top: 20px;">
          <button id="add-to-cart">åŠ å…¥è³¼ç‰©è»Š</button>
          <button id="product-wishlist-btn">
            <span id="product-heart-icon">â™¡</span>
          </button>
        </div>
      </div>

      <div class="product-review">
        <h2>å•†å“è©•åˆ†èˆ‡è©•è«–</h2>
        <h4>4.0 â˜…â˜…â˜…â˜…â˜† (100 æ¢è©•è«–)</h4>
        <select id="sortReview">
          <option value="latest">æ™‚é–“ï¼šæ–°â†’èˆŠ</option>
          <option value="oldest">æ™‚é–“ï¼šèˆŠâ†’æ–°</option>
          <option value="highest">è©•åˆ†ï¼šé«˜â†’ä½</option>
          <option value="lowest">è©•åˆ†ï¼šä½â†’é«˜</option>
        </select>
        <div class="product-reviews">
          <div class="reviews-list" id="reviews-list">
            <div class="review">
              <p class="reviewer-name">å°æ˜</p>
              <div class="review-rating">â˜…â˜…â˜…â˜…â˜†</div>
              <p class="review-text">åŒ…è£å¾ˆå®Œæ•´ï¼Œå¤ªå–œæ­¡äº†ï¼</p>
              <span class="review-date">2024/12/30</span>
            </div>
          </div>
          <button id="toggle-review-form" style="margin-top: 10px;">æˆ‘è¦å¯«è©•è«–</button>
          <div class="new-reviews" style="display: none;">
            <h2>æ–°å¢è©•è«–</h2>
            <div class="star" id="star-rating1"></div>
            <textarea id="review" placeholder="è«‹è¼¸å…¥è©•è«–"></textarea>
            <button id="submit-review">æäº¤è©•è«–</button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer>
    <div class="footer-container">
      <div class="footer-item">
        <img src="image/photo13.jpg" height="100px" width="150px">
        <div class="text-container">
          <p>ä¸­åŸå¤§å­¸è³‡ç®¡ç³»</p>
          <p>â˜€ å…¨æ—¥å…¬ä¼‘ï¼ˆé£Ÿç‰©è¢«ä»£è¨€äººåƒå®Œ è£œè²¨ä¸­~_~ï¼‰</p>
          <p>â˜ 0959277777</p>
          <p>âœ‰ pdhjzhd@gmail.com</p>
        </div>
      </div>
    </div>
    <div class="footer-bottom">
      <p>@2024 è‚¥å‘†æ‡·èˆŠé›œè²¨åº—</p>
    </div>
  </footer>

  <script>
  document.addEventListener("DOMContentLoaded", function () {
    const starContainer = document.getElementById("star-rating1");
    const reviewArea = document.querySelector('.new-reviews');
    const reviewList = document.getElementById("reviews-list");
    const productId = new URLSearchParams(window.location.search).get("id");

    document.getElementById("toggle-review-form").addEventListener("click", () => {
      reviewArea.style.display = 'block';
    });

    function sortReviews(criteria) {
      const reviewElements = Array.from(document.querySelectorAll("#reviews-list .review"));
      reviewElements.sort((a, b) => {
        const ratingA = a.querySelector(".review-rating").textContent.replace(/â˜†/g, "").length;
        const ratingB = b.querySelector(".review-rating").textContent.replace(/â˜†/g, "").length;
        const dateA = new Date(a.querySelector(".review-date").textContent);
        const dateB = new Date(b.querySelector(".review-date").textContent);
        switch (criteria) {
          case "highest": return ratingB - ratingA;
          case "lowest": return ratingA - ratingB;
          case "latest": return dateB - dateA;
          case "oldest": return dateA - dateB;
        }
      });
      reviewElements.forEach(el => reviewList.appendChild(el));
    }
    document.getElementById("sortReview").addEventListener("change", (e) => {
      sortReviews(e.target.value);
    });

    fetch("checkReviewPermission.jsp?productId=" + productId)
      .then(res => res.json())
      .then(data => {
        if (!data.isLogin) {
          reviewArea.innerHTML = '<p style="color:red;">è«‹å…ˆç™»å…¥æœƒå“¡å¾Œæ‰èƒ½æ’°å¯«è©•è«–ã€‚</p>';
        } else if (!data.canReview) {
          reviewArea.innerHTML = '<p style="color:red;">æ‚¨å°šæœªè³¼è²·æ­¤å•†å“ï¼Œç„¡æ³•æ’°å¯«è©•è«–ã€‚</p>';
        } else {
          reviewArea.style.display = 'none';
          for (let i = 1; i <= 5; i++) {
            const star = document.createElement("iconify-icon");
            star.setAttribute("icon", "material-symbols:star-outline");
            star.setAttribute("class", "star-icon");
            star.setAttribute("data-index", i);
            star.setAttribute("width", "40");
            starContainer.appendChild(star);
          }

          const stars = starContainer.querySelectorAll(".star-icon");
          stars.forEach((star, idx) => {
            star.addEventListener("click", () => {
              stars.forEach((s, i) => {
                s.setAttribute("icon", i <= idx ? "material-symbols:star" : "material-symbols:star-outline");
                s.classList.toggle("filled", i <= idx);
              });
            });
          });

          document.getElementById("submit-review").addEventListener("click", () => {
            const rating = document.querySelectorAll(".star-icon.filled").length;
            const comment = document.getElementById("review").value.trim();

            if (rating === 0 || comment === "") {
              alert("è«‹è¼¸å…¥è©•è«–å…§å®¹ä¸¦é¸æ“‡æ˜Ÿæ˜Ÿæ•¸ï¼");
              return;
            }

            const formData = new FormData();
            formData.append("productId", productId);
            formData.append("rating", rating);
            formData.append("comment", comment);

            fetch("addReview.jsp", {
              method: "POST",
              body: formData
            })
            .then(res => res.text())
            .then(result => {
              if (result.includes("success")) {
                alert("è©•è«–æˆåŠŸé€å‡ºï¼");
                const newDiv = document.createElement("div");
                newDiv.className = "review";
                const today = new Date().toISOString().split("T")[0];
                const starStr = "â˜…".repeat(rating) + "â˜†".repeat(5 - rating);
                newDiv.innerHTML = `
                  <p class="reviewer-name">æ‚¨</p>
                  <div class="review-rating">${starStr}</div>
                  <p class="review-text">${comment}</p>
                  <span class="review-date">${today}</span>`;
                reviewList.prepend(newDiv);
                document.getElementById("review").value = "";
                stars.forEach(s => {
                  s.setAttribute("icon", "material-symbols:star-outline");
                  s.classList.remove("filled");
                });
              } else {
                alert("é€å‡ºå¤±æ•—ï¼š" + result);
              }
            });
          });
        }
      });
  });
  </script>
</body>
</html>
